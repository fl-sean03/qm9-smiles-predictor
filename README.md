# CHEM555Project: QM9 Property Prediction Workflows

This repository presents four distinct feed-forward neural-network (FNN) pipelines for predicting nine molecular properties from the QM9 dataset. The project explores different featurization strategies and model architectures to compare their performance on this benchmark task.

The four implemented pipelines are:

1.  **Baseline**: A single-task FNN trained directly on Mordred descriptors.
2.  **Multitask**: A shared-encoder FNN utilizing Mordred descriptors for simultaneous prediction of all nine properties.
3.  **Autoencoder**: FNNs trained on latent space embeddings generated by an autoencoder pre-trained on Mordred descriptors.
4.  **Hybrid**: Single-task FNNs trained on a concatenated feature set of ECFP4 fingerprints and Mordred descriptors.

---

## üìÅ Repository Structure

```
.
‚îú‚îÄ‚îÄ .gitignore               # Specifies intentionally untracked files
‚îú‚îÄ‚îÄ README.md                # Project overview and instructions
‚îú‚îÄ‚îÄ data/                    # Raw and processed data files (excluded from Git)
‚îÇ   ‚îú‚îÄ‚îÄ mordred_features/    # Processed Mordred descriptors and embeddings
‚îÇ   ‚îî‚îÄ‚îÄ qm9/                 # Raw QM9 dataset files
‚îú‚îÄ‚îÄ outputs/                 # Generated output files (evaluation results included)
‚îÇ   ‚îú‚îÄ‚îÄ baseline/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ evaluation/      # Evaluation metrics, plots, and predictions for Baseline
‚îÇ   ‚îú‚îÄ‚îÄ multitask/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ eval_multitask/  # Evaluation results (metrics, plots, smaller CSVs)
‚îÇ   ‚îú‚îÄ‚îÄ autoencoder/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ eval_ae/         # Evaluation results (metrics, plots, smaller CSVs)
‚îÇ   ‚îî‚îÄ‚îÄ hybrid/
‚îÇ       ‚îî‚îÄ‚îÄ hybrid_eval/     # Evaluation results (metrics, plots, smaller CSVs)
‚îî‚îÄ‚îÄ src/                     # Source code for workflows
    ‚îú‚îÄ‚îÄ autoencoder/         # Code for Autoencoder pipeline
    ‚îú‚îÄ‚îÄ baseline/            # Code for Baseline pipeline
    ‚îú‚îÄ‚îÄ hybrid/              # Code for Hybrid pipeline
    ‚îú‚îÄ‚îÄ mordred/             # Code for Mordred descriptor generation and cleaning
    ‚îî‚îÄ‚îÄ multitask/           # Code for Multitask pipeline
```

---

## üöÄ Installation

1.  **Clone** the repository:
    ```bash
    git clone https://github.com/fl-sean03/qm9-smiles-predictor.git
    cd qm9-smiles-predictor
    ```
2.  **Set up** a Python 3.9+ virtual environment and install dependencies:
    ```bash
    python -m venv .venv
    source .venv/bin/activate
    pip install -r requirements.txt
    ```
    *(Ensure necessary libraries like `tensorflow`, `pandas`, `numpy`, `scikit-learn`, `rdkit`, and `mordred` are included in `requirements.txt`.)*

3.  **Prepare Data**:
    -   Obtain the raw QM9 dataset (`qm9_clean.csv`) and the extracted targets (`qm9_targets.csv`) and place them in `data/qm9/`.
    -   Generate or obtain the cleaned Mordred descriptors (`mordred_cleaned.csv`) and place it in `data/mordred_features/`.

---

## üìä Workflows

### 0. Data Preparation

This section outlines the steps to prepare the necessary data files: extracting QM9 targets and generating Mordred descriptors.

1.  **Generate QM9 Targets**: Extract the nine target properties and original index from `data/qm9/qm9_clean.csv`.
    ```bash
    python src/gen_qm9_targets.py \
      --input_csv data/qm9/qm9_clean.csv \
      --output_csv data/qm9/qm9_targets.csv
    ```

2.  **Extract Raw Mordred Descriptors**: Compute Mordred descriptors from the SMILES strings in `data/qm9/qm9_clean.csv`. This can be time-consuming for the full dataset.
    ```bash
    python src/mordred/extract_mordred.py \
      --input_csv data/qm9/qm9_clean.csv \
      --output_csv outputs/mordred_csvs/mordred_raw.csv
    ```

3.  **Clean Mordred Descriptors**: Clean the raw Mordred descriptors by removing columns with NaN or infinite values and dropping duplicate rows based on original index.
    ```bash
    python src/mordred/clean_mordred.py \
      --input_csv outputs/mordred_csvs/mordred_raw.csv \
      --output_csv data/mordred_features/mordred_cleaned.csv
    ```

4.  **Verify Cleaned Mordred Descriptors (Optional)**: Perform a sanity check on the cleaned Mordred descriptor file.
    ```bash
    python src/mordred/verify_mordred.py \
      --input_csv data/mordred_features/mordred_cleaned.csv
    ```

---

Each pipeline involves a sequence of scripts in the `src/` directory to perform featurization (if applicable), training, evaluation, and visualization. Below are the specific command-line workflows for each method, assuming you are in the repository's root directory and have activated the Python virtual environment.

### 1. Baseline (Mordred-only)

```bash
# 1) Train single-task FNNs on Mordred
python src/baseline/train_baseline_qm9.py \
  --descriptors_csv data/mordred_features/mordred_cleaned.csv \
  --targets_csv     data/qm9/qm9_targets.csv \
  --output_dir      outputs/baseline/model_run

# 2) Evaluate vs. paper MAEs
python src/baseline/eval_qm9.py \
  --descriptors_csv data/mordred_features/mordred_cleaned.csv \
  --targets_csv     data/qm9/qm9_targets.csv \
  --run_dir         outputs/baseline/model_run \
  --out_dir         outputs/baseline/evaluation

# 3) Visualize parity, residuals, comparison
python src/baseline/viz_qm9.py \
  --eval_dir       outputs/baseline/evaluation \
  --comparison_dir outputs/baseline/evaluation/comparison
```

---

### 2. Multitask (Mordred shared FNN)

```bash
# Train multitask FNN
python src/multitask/train_multitask_qm9.py \
  --descriptors_csv data/mordred_features/mordred_cleaned.csv \
  --targets_csv     data/qm9/qm9_targets.csv \
  --output_dir      outputs/multitask/multitask_run

# Evaluate multitask
python src/multitask/eval_multitask_qm9.py \
  --descriptors_csv data/mordred_features/mordred_cleaned.csv \
  --targets_csv     data/qm9/qm9_targets.csv \
  --model_path      outputs/multitask/multitask_best.h5 \
  --scaler_X        outputs/multitask/scalers/scaler_X.pkl \
  --scaler_y        outputs/multitask/scalers/scaler_y.pkl \
  --out_dir         outputs/multitask/eval_multitask

# Visualize multitask
python src/multitask/viz_multitask_qm9.py \
  --eval_dir       outputs/multitask/eval_multitask \
  --comparison_dir outputs/multitask/eval_multitask/comparison
```

---

### 3. Autoencoder (AE ‚Üí FNN)

```bash
# 1) Train autoencoder on Mordred features
python src/autoencoder/train_autoencoder.py \
  --input-desc   data/mordred_features/mordred_cleaned.csv \
  --output-dir   outputs/autoencoder/autoencoder_run \
  --bottleneck-dim 100

# 2) Generate AE embeddings
python src/autoencoder/featurize_autoencoder.py \
  --input-desc       data/mordred_features/mordred_cleaned.csv \
  --encoder-weights  outputs/autoencoder/autoencoder_run/encoder_best.weights.h5 \
  --scaler           outputs/autoencoder/autoencoder_run/scaler.pkl \
  --output-emb       data/mordred_features/X_autoencoder.npy

# 3) Train FNNs on AE embeddings
python src/autoencoder/train_qm9_with_ae.py \
  --embeddings        data/mordred_features/X_autoencoder.npy \
  --descriptors_csv   data/mordred_features/mordred_cleaned.csv \
  --targets_csv       data/qm9/qm9_targets.csv \
  --output_dir        outputs/autoencoder/fnn_ae_run

# 4) Evaluate AE-run FNNs
python src/autoencoder/eval_qm9_with_ae.py \
  --embeddings      data/mordred_features/X_autoencoder.npy \
  --descriptors_csv data/mordred_features/mordred_cleaned.csv \
  --targets_csv     data/qm9/qm9_targets.csv \
  --run_dir         outputs/autoencoder/fnn_ae_run \
  --out_dir         outputs/autoencoder/eval_ae # Corrected directory name

# 5) Visualize AE-run
python src/autoencoder/viz_qm9_with_ae.py \
  --eval_dir        outputs/autoencoder/eval_ae # Corrected directory name
  --comparison_dir  outputs/autoencoder/eval_ae/comparison # Corrected directory name
```

---

### 4. Hybrid (ECFP4 + Mordred)

```bash
# 1) Extract orig_index list from cleaned Mordred
cut -d, -f1 data/mordred_features/mordred_cleaned.csv > data/mordred_features/orig_idx.txt

# 2) Featurize: build hybrid fingerprint+Mordred matrix
python src/hybrid/featurize_hybrid.py \
  --smiles_csv  data/qm9/qm9_clean.csv \
  --desc_csv    data/mordred_features/mordred_cleaned.csv \
  --output_npy  data/mordred_features/X_hybrid.npy \
  --radius      2 \
  --nBits       1024

# 3) Train FNNs on hybrid features
python src/hybrid/train_hybrid.py \
  --embeddings     data/mordred_features/X_hybrid.npy \
  --orig_index     data/mordred_features/orig_idx.txt \
  --targets_csv    data/qm9/qm9_targets.csv \
  --output_dir     outputs/hybrid/hybrid_run \
  --batch_size     256 \
  --epochs         200 \
  --learning_rate  1e-3 \
  --hidden_layers  256,256 \
  --patience       10

# 4) Evaluate hybrid models
python src/hybrid/eval_hybrid.py \
  --embeddings   data/mordred_features/X_hybrid.npy \
  --orig_index   data/mordred_features/orig_idx.txt \
  --targets_csv  data/qm9/qm9_targets.csv \
  --run_dir      outputs/hybrid/hybrid_run \
  --out_dir      outputs/hybrid/hybrid_eval

# 5) Visualize hybrid
python src/hybrid/viz_hybrid.py \
  --eval_dir       outputs/hybrid/hybrid_eval \
  --comparison_dir outputs/hybrid/hybrid_eval/comparison
```

---

## ‚öôÔ∏è Configuration

Model hyperparameters and training settings can typically be adjusted via command-line arguments for each script. Refer to the individual script files in `src/` for specific options.

---

## üìÑ License & Citation

This project is based on the work presented in:

Pinheiro, M., et al. (2020). *Journal of Physical Chemistry A*, 124(43), 8973-8981.

Please cite the original paper if you use or build upon this work.

---

## ‚ú® Contributing

Contributions are welcome! Please refer to the contribution guidelines (if available) for details on how to submit pull requests.

---

## üéâ Acknowledgements

Acknowledge any individuals, organizations, or datasets that contributed to this project.

---

## üìß Contact

For questions or inquiries, please contact [Your Name/Email].

---